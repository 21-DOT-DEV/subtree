# Implementation Plan: Add Command

**Branch**: `004-add-command` | **Date**: 2025-10-27 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/004-add-command/spec.md`

## Summary

Implement the `subtree add` command with CLI-First workflow enabling users to add subtrees via command-line flags with smart defaults. The command derives name from remote URL, defaults prefix to name, uses 'main' as default ref, and creates single atomic commits combining subtree merge and config update using the commit-amend pattern. Includes duplicate detection (name OR prefix) before git operations and produces custom-formatted commit messages.

## Technical Context

**Language/Version**: Swift 6.1  
**Primary Dependencies**: ArgumentParser 1.6.1, Yams 6.1.0, swift-subprocess 0.1.0+, swift-system 1.5.0  
**Storage**: File-based (subtree.yaml at git repository root)  
**Testing**: Swift Testing (Swift 6 native, macro-based)  
**Target Platform**: macOS 13+, Ubuntu 20.04 LTS  
**Project Type**: Single CLI (Sources/SubtreeLib/ library + Sources/subtree/ executable)  
**Performance Goals**: Add operation completes in <10 seconds for typical repositories  
**Constraints**: Must work from any subdirectory within git repo, atomic commits mandatory (single commit per add), no network validation (delegate to git)  
**Scale/Scope**: Single command implementation, 35 functional requirements, 5 user stories (P1-P5)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

‚úÖ **Spec-First Development**: spec.md complete with user scenarios, acceptance criteria, functional requirements  
‚úÖ **Test-Driven Development**: Plan includes unit and integration tests written before implementation  
‚úÖ **Small, Independent Specs**: Single command, independently testable, does not depend on incomplete specs  
‚úÖ **CI & Quality Gates**: Existing CI (macOS + Ubuntu) will validate all tests  
‚úÖ **Agent Maintenance**: Will update .windsurf/rules after completion (trigger: major feature addition)

## Project Structure

### Documentation (this feature)

```text
specs/004-add-command/
‚îú‚îÄ‚îÄ spec.md              # Feature specification (complete)
‚îú‚îÄ‚îÄ plan.md              # This file
‚îú‚îÄ‚îÄ tasks.md             # Generated by this plan
‚îî‚îÄ‚îÄ checklists/
    ‚îî‚îÄ‚îÄ requirements.md  # Spec quality checklist (complete)
```

### Source Code (repository root)

```text
Sources/
‚îú‚îÄ‚îÄ SubtreeLib/          # Library module (all business logic)
‚îÇ   ‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AddCommand.swift          # Implement CLI-First add logic (STUB ‚Üí FULL)
‚îÇ   ‚îú‚îÄ‚îÄ Configuration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SubtreeConfig.swift   # Existing (from spec 002)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Parsing/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ConfigFileParser.swift # Existing (from spec 002)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validation/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ConfigValidator.swift  # Existing (from spec 002)
‚îÇ   ‚îî‚îÄ‚îÄ Utilities/
‚îÇ       ‚îú‚îÄ‚îÄ ConfigFileManager.swift    # Existing (from spec 003 - atomic file ops)
‚îÇ       ‚îú‚îÄ‚îÄ GitOperations.swift        # Existing (from spec 003 - git root, repo validation)
‚îÇ       ‚îú‚îÄ‚îÄ ExitCode.swift             # Existing (from spec 001)
‚îÇ       ‚îú‚îÄ‚îÄ URLParser.swift            # NEW - Extract name from URL
‚îÇ       ‚îú‚îÄ‚îÄ NameSanitizer.swift        # NEW - Sanitize invalid chars
‚îÇ       ‚îî‚îÄ‚îÄ CommitMessageFormatter.swift # NEW - Format custom commit messages
‚îî‚îÄ‚îÄ subtree/
    ‚îî‚îÄ‚îÄ main.swift       # Executable wrapper (existing)

Tests/
‚îú‚îÄ‚îÄ SubtreeLibTests/     # Unit tests
‚îÇ   ‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AddCommandTests.swift      # NEW - Unit tests for add logic
‚îÇ   ‚îî‚îÄ‚îÄ Utilities/
‚îÇ       ‚îú‚îÄ‚îÄ URLParserTests.swift       # NEW - Test URL parsing
‚îÇ       ‚îú‚îÄ‚îÄ NameSanitizerTests.swift   # NEW - Test char sanitization
‚îÇ       ‚îî‚îÄ‚îÄ CommitMessageFormatterTests.swift # NEW - Test message format
‚îî‚îÄ‚îÄ IntegrationTests/
    ‚îú‚îÄ‚îÄ AddIntegrationTests.swift      # NEW - End-to-end add command tests
    ‚îú‚îÄ‚îÄ TestHarness.swift              # Existing (from spec 001)
    ‚îî‚îÄ‚îÄ GitRepositoryFixture.swift     # Existing (from spec 001)
```

**Structure Decision**: Reuse existing Swift CLI structure (SubtreeLib library + subtree executable). Leverage existing utilities (GitOperations, ConfigFileManager) from init command and config specs. Add command-specific utilities for URL parsing, name sanitization, and commit message formatting.

## Technical Approach

### Architecture Pattern

**Command Structure**: ArgumentParser `AsyncParsableCommand` with flag-based interface

**Execution Flow**:
1. **Validation** ‚Üí Check git repo, config exists, URL format
2. **Default Resolution** ‚Üí Derive name from URL, prefix from name, ref='main'
3. **Duplicate Detection** ‚Üí Check config for existing name OR prefix
4. **Git Subtree Add** ‚Üí Execute `git subtree add` with squash flag
5. **Config Update** ‚Üí Add entry to subtree.yaml at git root (atomic file ops)
6. **Atomic Commit** ‚Üí `git commit --amend` with custom message format
7. **Output** ‚Üí Success message with emoji prefix

### Smart Defaults Implementation

**URL Parsing**:
- Extract final path segment from URL
- Handle https://, git@, file:// schemes
- Remove `.git` extension
- Sanitize invalid filesystem characters (/, :, \, etc.) ‚Üí replace with hyphens

**Prefix Defaulting**:
- If `--prefix` not provided, use name value (auto-derived or explicit)
- Maintains consistency: `--name lib ‚Üí prefix lib`

**Ref Defaulting**:
- Default to 'main' if `--ref` not provided
- User can override for tags, non-main branches

### Atomic Commit Pattern

**Sequence** (from clarifications):
1. Execute `git subtree add --squash <remote> <prefix> <ref>` ‚Üí creates commit with subtree files
2. Capture commit hash from git output
3. Update `subtree.yaml` with new entry using `ConfigFileManager.writeAtomically()`
4. Stage config file: `git add subtree.yaml`
5. Amend commit with custom message: `git commit --amend -F <message-file>`

**Custom Commit Message Format** (from clarifications):
```
Add subtree <name>
- Added from <ref-type>: <ref> (commit: <short-hash>)
- From: <remote-url>
- In: <prefix>
```

**Ref-type derivation**:
- 'tag' if ref starts with 'v' or matches semver pattern (e.g., v1.0.0, 0.7.0)
- 'branch' otherwise

**Short-hash**: First 8 characters of commit SHA-1

### Error Handling Strategy

**Validation Errors** (before git operations):
- Invalid URL format ‚Üí "‚ùå Invalid remote URL format: <url>"
- Missing config ‚Üí "‚ùå Configuration file not found. Run 'subtree init' first."
- Not in git repo ‚Üí "‚ùå Must be run inside a git repository"
- Duplicate name/prefix ‚Üí "‚ùå Subtree with name '<name>' already exists in configuration"

**Git Operation Failures** (during execution):
- Surface git error messages directly
- Exit with non-zero code

**Commit Amend Failure** (from clarifications):
- Leave subtree commit intact (no rollback)
- Provide recovery guidance: "Subtree added successfully but failed to update config in commit. Manually edit subtree.yaml to add entry, then run: git commit --amend"
- Exit with non-zero code

### Reusable Components

**From Init Command (spec 003)**:
- `GitOperations.findGitRoot()` - Resolve git root from any subdirectory, follow symlinks
- `GitOperations.isGitRepository()` - Validate inside git repo
- `ConfigFileManager.writeAtomically()` - Atomic config updates (temp file + rename)

**From Config Schema (spec 002)**:
- `SubtreeConfig` model - YAML structure definition
- `ConfigFileParser.parse()` - Load and parse subtree.yaml
- `ConfigValidator.validate()` - Validate config entries

**From Bootstrap (spec 001)**:
- `ExitCode` enum - Standardized exit codes
- `TestHarness` - CLI execution for integration tests
- `GitRepositoryFixture` - Temporary git repos for testing

### New Utilities Required

**URLParser**:
- `extractName(from url: String) throws -> String` - Parse repo name from URL
- Supports https://, git@, file:// schemes
- Throws on invalid URL format or empty result

**NameSanitizer**:
- `sanitize(_ name: String) -> String` - Replace invalid chars with hyphens
- Invalid chars: `/`, `:`, `\`, and filesystem-specific chars
- Preserves alphanumeric, hyphens, underscores

**CommitMessageFormatter**:
- `format(name:, ref:, refType:, commit:, remote:, prefix:) -> String` - Generate custom message
- `deriveRefType(from ref: String) -> String` - Determine 'tag' vs 'branch'
- `shortHash(from commit: String) -> String` - First 8 chars

## Implementation Phases

### Phase 1: Setup
- Update AddCommand.swift structure with ArgumentParser flags
- Create utility files (URLParser, NameSanitizer, CommitMessageFormatter)
- Update test directory structure

### Phase 2: Foundational
- **No foundational work required** - All infrastructure exists from previous specs

### Phase 3: User Story 1 - Minimal Subtree Addition (P1) üéØ MVP
- Implement smart defaults (URL parsing, name/prefix/ref resolution)
- Implement validation (git repo, config exists, URL format)
- Implement duplicate detection (config check)
- Implement git subtree operation execution
- Implement atomic commit with config update
- Success output with emoji prefix

### Phase 4: User Story 2 - Override Smart Defaults (P2)
- Implement `--name` override
- Implement `--prefix` override
- Implement `--ref` override
- Ensure prefix defaults from name when name explicitly provided

### Phase 5: User Story 3 - No-Squash Mode (P3)
- Implement `--no-squash` flag
- Conditional squash flag in git subtree command
- Track squash setting in config

### Phase 6: User Story 4 - Duplicate Prevention (P4)
- Enhance duplicate detection with clear error messages
- Test name collision scenarios
- Test prefix collision scenarios

### Phase 7: User Story 5 - Error Handling & Validation (P5)
- Enhance error messages for all failure scenarios
- Implement commit amend failure recovery guidance
- Test all error paths

### Phase 8: Polish
- Documentation updates
- Code cleanup and refactoring
- Performance validation (<10s requirement)
- Run quickstart validation

## Testing Strategy

### Unit Tests (SubtreeLibTests/)

**URLParserTests.swift**:
- Test https:// URL parsing
- Test git@ URL parsing
- Test file:// URL parsing
- Test .git extension removal
- Test invalid URL handling
- Test empty/malformed URLs

**NameSanitizerTests.swift**:
- Test alphanumeric preservation
- Test invalid char replacement (/, :, \)
- Test hyphen/underscore preservation
- Test empty string handling

**CommitMessageFormatterTests.swift**:
- Test message format structure
- Test ref-type derivation (tag vs branch)
- Test short-hash extraction
- Test semver pattern matching

**AddCommandTests.swift**:
- Test flag parsing
- Test default resolution logic
- Test validation checks
- Test duplicate detection logic

### Integration Tests (IntegrationTests/)

**AddIntegrationTests.swift**:

**User Story 1 (P1) Tests**:
- Test minimal add (only --remote)
- Test single atomic commit produced
- Test config entry created with correct values
- Test success message output

**User Story 2 (P2) Tests**:
- Test --name override
- Test --prefix override
- Test --ref override
- Test multiple overrides together

**User Story 3 (P3) Tests**:
- Test --no-squash flag
- Test config squash=false saved
- Test git log shows individual commits

**User Story 4 (P4) Tests**:
- Test duplicate name detection
- Test duplicate prefix detection
- Test error message format

**User Story 5 (P5) Tests**:
- Test invalid URL error
- Test missing config error
- Test not in git repo error
- Test git operation failure handling

## Dependencies

### External Dependencies
- ArgumentParser 1.6.1 (existing)
- Yams 6.1.0 (existing)
- swift-subprocess 0.1.0+ (existing)
- swift-system 1.5.0 (existing)

### Internal Dependencies
- `GitOperations` - Git root detection, repo validation
- `ConfigFileManager` - Atomic config file operations
- `ConfigFileParser` - Parse subtree.yaml
- `SubtreeConfig` - Config data model
- `ExitCode` - Standard exit codes
- `TestHarness` - Integration test execution
- `GitRepositoryFixture` - Test git repository creation

### Task Dependencies
- URLParser, NameSanitizer, CommitMessageFormatter MUST exist before AddCommand implementation
- Unit tests MUST be written and verified to fail before implementing functionality
- User Story 1 (P1) MUST complete before P2-P5 (provides core functionality)
- P2-P5 can be implemented in any order after P1 completes

## Risks & Mitigations

**Risk**: Git subtree command behavior varies across git versions  
**Mitigation**: Document minimum git version (2.x+), integration tests catch breaking changes

**Risk**: URL parsing doesn't handle all git URL formats  
**Mitigation**: Support standard formats (https, git@, file://), let git validate reachability

**Risk**: Commit amend conflicts with concurrent operations  
**Mitigation**: Git handles locking, surface conflict error to user with recovery guidance

**Risk**: Name derivation produces collisions for similarly-named repos  
**Mitigation**: User can override with --name flag, duplicate detection catches collisions

**Risk**: Performance degrades for large repositories  
**Mitigation**: Profile git subtree operation (major bottleneck), optimize config parsing if needed

## Success Criteria

‚úÖ Users can add subtrees with minimal flags (only --remote required)  
‚úÖ 100% of add operations produce exactly one atomic commit  
‚úÖ Duplicate detection prevents name/prefix collisions before git operations  
‚úÖ Smart defaults work for 90%+ of URLs (GitHub, GitLab, Bitbucket)  
‚úÖ All 115+ tests pass (7 foundation + 20 unit + 88 integration from existing + new add tests)  
‚úÖ Performance: Add completes in <10 seconds for typical repositories  
‚úÖ Cross-platform: Works identically on macOS 13+ and Ubuntu 20.04 LTS
