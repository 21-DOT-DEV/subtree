# Implementation Plan: Update Command

**Branch**: `005-update-command` | **Date**: 2025-10-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-update-command/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow in `.specify/templates/commands/plan.md`.

## Summary

The Update Command enables users to update subtrees to their latest versions with flexible commit strategies. Core functionality includes selective updates by name, bulk updates with `--all`, report mode for CI/CD safety checks (exit code 5 if updates available), and squash/no-squash history preservation options. All updates produce atomic commits (subtree + config update in single commit) following the established pattern from Add Command. Report mode uses `git ls-remote` for truly read-only remote queries without modifying local repository state.

## Technical Context

**Language/Version**: Swift 6.1  
**Primary Dependencies**: 
- swift-argument-parser 1.6.1 (CLI framework)
- Yams 6.1.0 (YAML parsing)
- swift-subprocess 0.1.0+ (process execution)
- swift-system 1.5.0 (file operations)

**Storage**: File-based (subtree.yaml YAML configuration)  
**Testing**: Swift Testing (built into Swift 6.1), integration tests with GitRepositoryFixture  
**Target Platform**: macOS 13+, Ubuntu 20.04 LTS  
**Project Type**: Single CLI application (library + executable pattern)  
**Performance Goals**: 
- Report mode completes in <5 seconds for repos with 20 subtrees
- Single subtree update in <10 seconds for typical repositories (<1000 commits delta)

**Constraints**: 
- Atomic commits required (one commit per subtree update)
- Read-only report mode (no repository modification)
- Clean working tree validation before updates
- No automatic network retries (fail-fast)

**Scale/Scope**: Command-line tool managing 1-20 subtrees per repository typically

**Design Decisions from Planning Clarifications**:
1. **Atomic Commit Pattern**: Reuse Add Command's `executeAtomicSubtreeOperation()` with new update operation case
2. **Report Mode Strategy**: Use `git ls-remote` for truly read-only remote queries (no local ref updates)
3. **Config Update Timing**: Update subtree.yaml after git subtree operation, before commit-amend (matches Add Command pattern)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Spec-First Development ✅

- **Status**: PASS
- **Evidence**: Complete spec.md with 5 user stories, acceptance criteria in Given-When-Then format, 18 functional requirements, and measurable success criteria
- **Clarifications**: 5 technical ambiguities resolved through planning clarification workflow (atomic commit pattern, report mode strategy, config update timing, batch exit codes, commit message format)

### Principle II: Test-Driven Development ✅

- **Status**: PASS
- **Evidence**: Test harness established in bootstrap spec (001), GitRepositoryFixture available for integration tests, Swift Testing framework in place
- **Approach**: Tests will be written for each user story before implementation, following Add Command's proven TDD pattern

### Principle III: Small, Independent Specs ✅

- **Status**: PASS
- **Evidence**: Single feature (Update Command), independently testable, builds on Add Command foundation, prioritized user stories (2x P1, 2x P2, 1x P3)
- **Scope**: Update operations only - no other command behaviors included

### Principle IV: CI & Quality Gates ✅

- **Status**: PASS
- **Evidence**: CI pipeline established (macOS-15 + Ubuntu 20.04), all 150 tests currently passing, contract tests verify CLI stability
- **Requirements**: New tests must pass on both platforms before merge

### Principle V: Agent Maintenance Rules ✅

- **Status**: PASS
- **Trigger Assessment**: This spec introduces new command (major feature area - trigger #5)
- **Action Required**: Update `.windsurf/rules/` after implementation to document Update Command and any new utilities created

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
Sources/
├── SubtreeLib/           # Library module (all business logic)
│   ├── Commands/         # Command implementations
│   │   ├── SubtreeCommand.swift
│   │   ├── InitCommand.swift
│   │   ├── AddCommand.swift
│   │   └── UpdateCommand.swift  # NEW: This feature
│   ├── Configuration/    # Config models and management
│   │   ├── SubtreeConfiguration.swift
│   │   ├── SubtreeEntry.swift
│   │   └── ConfigFileManager.swift
│   └── Utilities/        # Shared utilities
│       ├── GitOperations.swift
│       ├── ExitCode.swift
│       ├── URLParser.swift
│       ├── NameSanitizer.swift
│       └── CommitMessageFormatter.swift
└── subtree/             # Executable module (thin wrapper)
    └── EntryPoint.swift

Tests/
├── SubtreeLibTests/      # Unit tests
│   ├── CommandTests.swift
│   ├── ConfigurationTests/
│   └── UtilitiesTests/
└── IntegrationTests/     # Integration tests
    ├── TestHarness.swift
    ├── GitRepositoryFixture.swift
    ├── UpdateCommandIntegrationTests.swift  # NEW: This feature
    └── [other command tests]
```

**Structure Decision**: Swift Package Manager with Library + Executable pattern. All business logic in SubtreeLib (testable), thin executable wrapper in subtree/. Update Command will follow established patterns from Add Command (atomic commits, config management, error handling).

## Complexity Tracking

No constitution violations - complexity tracking not required.

---

## Post-Phase 1 Constitution Check

*Re-check after completing design artifacts (research.md, data-model.md, contracts/, quickstart.md)*

### Design Completeness ✅

- **research.md**: All technical unknowns resolved, best practices documented
- **data-model.md**: Entities defined with validation rules and relationships
- **contracts/**: CLI contract specifies behavior, exit codes, error handling
- **quickstart.md**: TDD workflow and validation checklist provided
- **Agent context**: Updated via update-agent-context.sh

### Constitution Compliance ✅

All principles remain satisfied after design phase:

- **Principle I**: Spec-first maintained (all design derived from spec.md)
- **Principle II**: TDD approach documented in quickstart.md
- **Principle III**: Scope unchanged (single feature, independent)
- **Principle IV**: CI requirements unchanged (existing pipeline sufficient)
- **Principle V**: Agent context updated with new command information

**Status**: READY FOR IMPLEMENTATION (Phase 2: /speckit.tasks)

---

## Next Steps

This completes the `/speckit.plan` workflow. The feature is now ready for task breakdown and implementation:

### 1. Generate Task List

```bash
/speckit.tasks
```

This will create `tasks.md` with dependency-ordered implementation steps.

### 2. Implementation Phase

Follow TDD discipline per Constitution Principle II:
1. Write failing tests for each user story
2. Implement minimal code to pass tests
3. Refactor while keeping tests green
4. Verify all acceptance criteria met

### 3. Validation

Use `quickstart.md` validation checklist to verify:
- All 18 functional requirements (FR-001 to FR-018)
- All 7 success criteria (SC-001 to SC-007)
- Performance targets met (<5s report mode, <10s updates)
- CI passes on both platforms (macOS + Ubuntu)

### 4. Agent Rules Update

After successful implementation, update `.windsurf/rules/` per Principle V (major feature trigger #5).

---

## Summary

**Feature**: Update Command enables updating subtrees to latest versions with atomic commits, report mode for CI/CD, and flexible squash options.

**Key Decisions**:
- Reuse Add Command's atomic commit pattern (`executeAtomicSubtreeOperation()`)
- Use `git ls-remote` for read-only report mode
- Update config after git subtree, before commit-amend
- Batch updates continue-on-error, exit 1 if any failures
- Tag-aware commit messages with structured metadata

**Design Artifacts Generated**:
- ✅ plan.md (this file)
- ✅ research.md (5 technical decisions documented)
- ✅ data-model.md (4 entities with validation rules)
- ✅ contracts/update-command-contract.md (CLI interface contract)
- ✅ quickstart.md (TDD workflow & validation guide)

**Constitution Status**: All principles satisfied, ready for implementation.

**Next Command**: `/speckit.tasks` to generate implementation task list.
