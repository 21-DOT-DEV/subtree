# Implementation Plan: Case-Insensitive Names & Validation

**Branch**: `007-case-insensitive-names` | **Date**: 2025-10-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-case-insensitive-names/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following 3 clarifying questions about scope and organization.

## Summary

Implements case-insensitive name matching for subtree operations (remove, update, future commands) while preventing duplicate names and prefixes to ensure cross-platform config portability. Adds validation infrastructure for path security (relative paths only, no traversal), whitespace normalization, and non-ASCII character handling with user guidance. Modifies existing Add, Remove, and Update commands to use shared validation utilities. Defers comprehensive `lint` command implementation to future spec per roadmap Phase 3.

## Technical Context

**Language/Version**: Swift 6.1 (strict concurrency, modern Swift features)
**Primary Dependencies**:
- swift-argument-parser 1.6.1 (CLI framework, ParsableCommand)
- Yams 6.1.0 (YAML parsing for subtree.yaml)
- swift-subprocess 0.1.0+ (git command execution)
- swift-system 1.5.0 (file operations, pinned for Ubuntu 20.04 compatibility)

**Storage**: File-based (subtree.yaml config at repository root)
**Testing**: Swift Testing (Swift 6 native, macro-based @Test/@Suite)
**Target Platform**: macOS 13+ (Xcode 16.4), Ubuntu 20.04 LTS
**Project Type**: Single CLI application (Library + Executable pattern)

**Performance Goals**:
- Config validation overhead: <50ms (SC-010)
- Name matching: O(n) where n = number of subtrees (typically <100)
- Path validation: <1ms per path (regex-based)

**Constraints**:
- Cross-platform: Configs must work identically on macOS (case-insensitive FS) and Linux (case-sensitive FS)
- No breaking changes: Existing commands (add, remove, update) must maintain backward compatibility
- Zero external network calls: All validation is local/offline (lint command with remotes deferred)

**Scale/Scope**:
- Typical config: 5-50 subtrees per repository
- Max config size: ~1000 subtrees (YAML parsing performance acceptable)
- Command invocation: CLI tool called multiple times per session (fast startup critical)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… I. Spec-First Development
- **spec.md exists**: Yes - comprehensive specification with 5 user stories
- **User scenarios defined**: Yes - 22 acceptance scenarios in Given-When-Then format
- **Technology-agnostic**: Yes - focuses on behavior, validation rules, error messages
- **Success criteria**: Yes - 11 measurable outcomes (SC-001 through SC-011)
- **Clarifications resolved**: Yes - 5 questions answered during /speckit.clarify session

### â³ II. Test-Driven Development
- **Tests written first**: Pending - will be defined in Phase 1 contracts
- **TDD discipline**: Plan specifies hybrid test organization (validation utilities + command integration)
- **Test verification**: Will verify failing tests before implementation per constitution

**Status**: Ready to proceed - tests will be written during Phase 1 design

### âœ… III. Small, Independent Specs
- **Single feature**: Yes - case-insensitive validation only (lint command deferred per clarification #1)
- **Independently testable**: Yes - each user story can be tested independently
- **Deployable increment**: Yes - adds validation to existing commands without breaking changes
- **No incomplete dependencies**: Yes - builds on completed Add/Remove/Update commands

### âœ… IV. CI & Quality Gates
- **Existing CI**: Yes - ci.yml runs on macOS-15 + Ubuntu 20.04
- **Test requirements**: Will add ValidationTests + integration tests to existing suites
- **Platform coverage**: No changes needed - existing matrix covers targets
- **Merge policy**: All tests must pass - no exceptions

### âœ… V. Agent Maintenance Rules
- **Update trigger**: Yes - adds validation utilities (major feature area per Principle V.1.5)
- **Timing**: Will update .windsurf/rules after successful implementation
- **Content**: Add validation patterns, test organization, modified commands

**GATE STATUS**: âœ… **PASS** - All constitutional requirements met, ready for Phase 0 research

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
Sources/
â”œâ”€â”€ SubtreeLib/                 # Library module (all business logic)
â”‚   â”œâ”€â”€ Commands/               # Command implementations
â”‚   â”‚   â”œâ”€â”€ AddCommand.swift    # âœï¸ Will modify (add validation calls)
â”‚   â”‚   â”œâ”€â”€ RemoveCommand.swift # âœï¸ Will modify (add case-insensitive lookup)
â”‚   â”‚   â”œâ”€â”€ UpdateCommand.swift # âœï¸ Will modify (add case-insensitive lookup)
â”‚   â”‚   â””â”€â”€ InitCommand.swift   # No changes needed
â”‚   â”œâ”€â”€ Configuration/          # Config models & I/O
â”‚   â”‚   â”œâ”€â”€ SubtreeConfig.swift # âœï¸ Will extend (add validation methods)
â”‚   â”‚   â””â”€â”€ ConfigFileManager.swift
â”‚   â””â”€â”€ Utilities/              # ðŸ†• Will add validation utilities
â”‚       â”œâ”€â”€ NameMatcher.swift           # NEW: Case-insensitive matching
â”‚       â”œâ”€â”€ DuplicateValidator.swift    # NEW: Duplicate detection
â”‚       â”œâ”€â”€ PathValidator.swift         # NEW: Path format validation
â”‚       â”œâ”€â”€ WhitespaceNormalizer.swift  # NEW: Trim logic
â”‚       â””â”€â”€ ValidationError.swift       # NEW: Error types
â””â”€â”€ subtree/
    â””â”€â”€ EntryPoint.swift        # No changes needed

Tests/
â”œâ”€â”€ SubtreeLibTests/            # Unit tests
â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”œâ”€â”€ AddCommandTests.swift    # âœï¸ Will extend (validation scenarios)
â”‚   â”‚   â”œâ”€â”€ RemoveCommandTests.swift # âœï¸ Will extend (case-insensitive scenarios)
â”‚   â”‚   â””â”€â”€ UpdateCommandTests.swift # âœï¸ Will extend (case-insensitive scenarios)
â”‚   â”œâ”€â”€ ConfigurationTests/
â”‚   â”‚   â””â”€â”€ SubtreeConfigTests.swift # âœï¸ Will extend (validation tests)
â”‚   â””â”€â”€ Utilities/              # ðŸ†• NEW test suite
â”‚       â”œâ”€â”€ NameMatcherTests.swift
â”‚       â”œâ”€â”€ DuplicateValidatorTests.swift
â”‚       â”œâ”€â”€ PathValidatorTests.swift
â”‚       â””â”€â”€ WhitespaceNormalizerTests.swift
â””â”€â”€ IntegrationTests/           # Integration tests
    â”œâ”€â”€ AddIntegrationTests.swift    # âœï¸ Will extend (duplicate prevention)
    â”œâ”€â”€ RemoveIntegrationTests.swift # âœï¸ Will extend (case-insensitive removal)
    â””â”€â”€ UpdateIntegrationTests.swift # âœï¸ Will extend (case-insensitive update)
```

**Structure Decision**: Library + Executable pattern (established by bootstrap spec 001). All validation logic goes in `SubtreeLib/Utilities/` as reusable components. Command modifications are minimal - add validation hooks to existing implementations. Tests follow hybrid organization (clarification #3): validation utilities get dedicated test suite, command integration tests extend existing command test files.

## Complexity Tracking

**No violations** - Constitution Check passed all gates. This feature adds validation utilities following established patterns (utility modules in SubtreeLib/Utilities/), extends existing commands with minimal modifications, and uses hybrid test organization.

---

## Phase Outputs

### âœ… Phase 0: Research (Complete)
- **File**: [research.md](./research.md)
- **Decisions**: 7 technical decisions resolved (case-insensitive comparison, path validation, duplicate detection, whitespace, non-ASCII, validation timing, error formatting)
- **Dependencies**: None required - uses Swift standard library only

### âœ… Phase 1: Design (Complete)
- **Files**: [data-model.md](./data-model.md), [contracts/](./contracts/), [quickstart.md](./quickstart.md)
- **Data Model**: No schema changes - extends SubtreeConfig with validation methods
- **Contracts**: 3 command contracts (add-command.md, remove-command.md, update-command.md)
- **Agent Context**: Updated via `update-agent-context.sh windsurf`

### â³ Phase 2: Tasks (Next Step)
- **Command**: Run `/speckit.tasks` to generate dependency-ordered task list
- **Output**: `tasks.md` with TDD implementation steps
- **Dependencies**: Ready - all design artifacts complete

---

## Summary

**Planning complete** - All constitutional gates passed, technical decisions made, design artifacts generated.

**Key Decisions from Clarifications**:
1. Lint command deferred to separate spec (Phase 3 per roadmap)
2. Update Command included in modifications (consistent UX)
3. Hybrid test organization (validation utilities + command integration)

**Implementation Scope**:
- 5 new validation utilities (~200 lines)
- 4 modified files (SubtreeConfig + 3 commands, ~130 lines changes)
- ~350 lines of tests (100% coverage target)
- No breaking changes, additive validation only

**Performance**: <50ms validation overhead (SC-010), suitable for typical configs (5-50 subtrees)

**Next Command**: `/speckit.tasks` - Generate task breakdown for TDD implementation

---

**Branch**: 007-case-insensitive-names  
**Spec**: [spec.md](./spec.md)  
**Plan**: This file  
**Status**: Design complete, ready for task generation
